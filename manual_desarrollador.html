<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual del Desarrollador - Dashboard de Ventas</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css");

        :root {
            --odoo-primary: #875A7B;
            --odoo-primary-dark: #6B4563;
            --text-primary: #2c3e50;
            --text-secondary: #555;
            --bg-light: #f8f9fa;
            --border-color: #e0e6ed;
            --accent-color: #3498db;
            --code-bg: #2d2d2d;
            --code-text: #f8f8f2;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.7;
            color: var(--text-secondary);
            background-color: #fdfdff;
            margin: 0;
            display: flex;
        }

        #toc {
            width: 280px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            background: var(--bg-light);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
        }

        #toc h2 {
            color: var(--odoo-primary);
            font-size: 1.5rem;
            margin-top: 0;
            border-bottom: 2px solid var(--odoo-primary-dark);
            padding-bottom: 10px;
        }

        #toc ul {
            list-style: none;
            padding: 0;
        }

        #toc li a {
            display: block;
            padding: 10px 15px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
        }

        #toc li a:hover, #toc li a.active {
            background-color: var(--odoo-primary);
            color: white;
            transform: translateX(5px);
        }

        main {
            margin-left: 320px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
        }

        section {
            margin-bottom: 60px;
            padding-top: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 30px;
        }

        h1, h2, h3, h4 {
            color: var(--text-primary);
            font-weight: 600;
        }

        h1 {
            font-size: 2.8rem;
            color: var(--odoo-primary-dark);
            margin-bottom: 20px;
        }

        h2 {
            font-size: 2rem;
            border-bottom: 2px solid var(--odoo-primary);
            padding-bottom: 10px;
            margin-top: 0;
        }

        h3 {
            font-size: 1.4rem;
            color: var(--odoo-primary);
            margin-top: 30px;
        }

        h4 {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-top: 25px;
            border-left: 3px solid var(--accent-color);
            padding-left: 10px;
        }

        p, li {
            font-size: 1rem;
        }

        code {
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            color: #c7254e;
        }

        pre {
            background-color: var(--code-bg);
            color: var(--code-text);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .note {
            background-color: #e7f3fe;
            border-left: 5px solid var(--accent-color);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .note strong {
            color: var(--accent-color);
        }

        .bi {
            margin-right: 8px;
        }
    </style>
</head>
<body>

    <nav id="toc">
        <h2><i class="bi bi-code-slash"></i>Dev Manual</h2>
        <ul>
            <li><a href="#introduccion">Introducci√≥n</a></li>
            <li><a href="#arquitectura-proyecto">Arquitectura del Proyecto</a></li>
            <li><a href="#dependencias-versiones">Dependencias</a></li>
            <li><a href="#flujo-sales">Flujo de Datos: Ventas (/sales)</a></li>
            <li><a href="#flujo-pending">Flujo de Datos: Pendientes (/pending)</a></li>
            <li><a href="#sistema-cache">Sistema de Cach√©</a></li>
            <li><a href="#integracion-google-sheets">Integraci√≥n con Google Sheets</a></li>
            <li><a href="#logica-dashboards">L√≥gica de los Dashboards</a></li>
        </ul>
    </nav>

    <main>
        <h1><i class="bi bi-gear-fill"></i>Manual del Desarrollador</h1>

        <section id="introduccion">
            <h2><i class="bi bi-diagram-3"></i>Introducci√≥n</h2>
            <p>
                Este manual describe la arquitectura y el flujo de datos de las secciones m√°s importantes de la aplicaci√≥n: las vistas de <strong>Ventas Facturadas</strong> (<code>/sales</code>) y <strong>Pedidos Pendientes</strong> (<code>/pending</code>).
            </p>
            <p>
                El objetivo es proporcionar una gu√≠a t√©cnica para entender c√≥mo se obtienen los datos desde Odoo, c√≥mo se procesan en el backend de Flask y c√≥mo se presentan en el frontend.
            </p>
        </section>

        <section id="arquitectura-proyecto">
            <h2><i class="bi bi-diagram-3-fill"></i> Arquitectura del Proyecto</h2>
            <p>
                La aplicaci√≥n sigue una arquitectura de capas bien definida, lo que facilita su mantenimiento y escalabilidad. Las responsabilidades est√°n claramente separadas en las siguientes capas:
            </p>

            <h4>Capa de L√≥gica de Negocio (<code>app.py</code>)</h4>
            <p>
                Este archivo es el cerebro de la aplicaci√≥n. Orquesta todas las operaciones:
                <ul>
                    <li>Define todas las rutas (URLs) de la aplicaci√≥n Flask.</li>
                    <li>Maneja las peticiones HTTP (GET, POST) de los usuarios.</li>
                    <li>Coordina las llamadas a las capas de acceso a datos (los "managers") para obtener la informaci√≥n necesaria.</li>
                    <li>Procesa, agrega y transforma los datos crudos en estructuras listas para ser visualizadas (KPIs, datos para gr√°ficos, etc.).</li>
                    <li>Pasa los datos procesados a la capa de presentaci√≥n para su renderizado.</li>
                </ul>
            </p>

            <h4>Capa de Acceso a Datos (Managers)</h4>
            <p>
                Esta capa abstrae la complejidad de la comunicaci√≥n con las fuentes de datos externas.
                <ul>
                    <li><strong><code>odoo_manager.py</code>:</strong> Encapsula toda la l√≥gica para conectarse y consultar la API XML-RPC de Odoo. Contiene m√©todos espec√≠ficos como <code>get_sales_lines</code> o <code>get_pending_orders</code> que devuelven datos de Odoo en un formato estructurado.</li>
                    <li><strong><code>google_sheets_manager.py</code>:</strong> Se encarga de la interacci√≥n con la API de Google Sheets. Proporciona m√©todos para leer y escribir las metas de venta y la configuraci√≥n de los equipos comerciales.</li>
                </ul>
            </p>

            <h4>Capa de Presentaci√≥n (<code>templates/</code>)</h4>
            <p>
                Contiene todos los archivos HTML que el usuario ve. Utiliza el motor de plantillas <strong>Jinja2</strong> para renderizar din√°micamente el contenido.
                <ul>
                    <li>Recibe los datos procesados desde <code>app.py</code>.</li>
                    <li>Utiliza bucles, condicionales y filtros de Jinja2 para mostrar la informaci√≥n.</li>
                    <li>Inyecta datos en formato JSON dentro de etiquetas <code>&lt;script&gt;</code> para que sean consumidos por las librer√≠as de gr√°ficos (ECharts, Chart.js).</li>
                </ul>
            </p>

            <h4>Archivos Est√°ticos y Configuraci√≥n</h4>
            <ul>
                <li><strong><code>static/</code>:</strong> Almacena archivos CSS, JavaScript del lado del cliente e im√°genes.</li>
                <li><strong><code>.env</code>:</strong> Archivo crucial que almacena todas las credenciales y configuraciones sensibles (URLs, contrase√±as, claves de API) fuera del c√≥digo fuente, garantizando la seguridad.</li>
            </ul>
        </section>

        <section id="dependencias-versiones">
            <h2><i class="bi bi-box-seam"></i> Dependencias</h2>
            <p>
                Las dependencias del proyecto se gestionan a trav√©s de un archivo <code>requirements.txt</code> (no incluido en el contexto, pero es una pr√°ctica est√°ndar). A continuaci√≥n se listan las tecnolog√≠as y librer√≠as m√°s importantes.
            </p>

            <h4>Backend</h4>
            <ul>
                <li><strong>Python:</strong> Lenguaje principal.</li>
                <li><strong>Flask:</strong> Micro-framework web para la estructura de la aplicaci√≥n.</li>
                <li><strong>xmlrpc.client:</strong> Librer√≠a nativa de Python para la comunicaci√≥n con la API de Odoo.</li>
                <li><strong>gspread & google-auth:</strong> Para la autenticaci√≥n y manipulaci√≥n de Google Sheets.</li>
                <li><strong>Pandas:</strong> Utilizado para la manipulaci√≥n avanzada y agregaci√≥n de datos.</li>
                <li><strong>python-dotenv:</strong> Para cargar las variables de entorno desde el archivo <code>.env</code>.</li>
                <li><strong>openpyxl:</strong> Para generar los archivos de exportaci√≥n en formato <code>.xlsx</code>.</li>
                <li><strong>Flask-Caching:</strong> Para implementar el sistema de cach√© en memoria.</li>
            </ul>

            <h4>Frontend</h4>
            <ul>
                <li><strong>HTML5 & Jinja2:</strong> Para la estructura y el renderizado din√°mico de las p√°ginas.</li>
                <li><strong>CSS3:</strong> Para el dise√±o y la apariencia visual.</li>
                <li><strong>JavaScript:</strong> Para la interactividad del cliente (gr√°ficos, eventos).</li>
                <li><strong>ECharts & Chart.js:</strong> Librer√≠as de visualizaci√≥n de datos.</li>
            </ul>
        </section>

        <section id="flujo-sales">
            <h2><i class="bi bi-table"></i>Flujo de Datos: Ventas (/sales)</h2>
            <p>
                Esta secci√≥n muestra un listado paginado y filtrable de todas las l√≠neas de facturas de venta que pertenecen al canal internacional.
            </p>

            <h3>1. Interfaz de Usuario (<code>templates/sales.html</code>)</h3>
            <p>
                La interfaz contiene un formulario de filtros que env√≠a los par√°metros al backend.
            </p>
            <ul>
                <li><strong>M√©todo de Env√≠o:</strong> El formulario utiliza <code>method="POST"</code> para enviar los filtros. La paginaci√≥n funciona con par√°metros GET en la URL (ej. <code>?page=2</code>).</li>
                <li><strong>Campos de Filtro:</strong> Se incluyen campos para rango de fechas (<code>date_from</code>, <code>date_to</code>), un t√©rmino de b√∫squeda general (<code>search_term</code>) y un selector de clientes (<code>partner_id</code>).</li>
                <li><strong>Renderizado:</strong> Los datos recibidos del backend en la variable <code>sales_data</code> se iteran para construir las filas de la tabla. El objeto <code>pagination</code> se usa para generar los controles de paginaci√≥n.</li>
            </ul>

            <h3>2. Backend (<code>app.py</code> - ruta <code>/sales</code>)</h3>
            <p>
                La funci√≥n <code>sales()</code> orquesta todo el proceso en el servidor.
            </p>
            <ol>
                <li><strong>Recepci√≥n de Filtros:</strong> Lee los par√°metros de filtro desde <code>request.form</code> (para POST) o <code>request.args</code> (para GET). Esto permite que los filtros persistan al cambiar de p√°gina.</li>
                <li><strong>Llamada al Manager:</strong> Invoca a <code>data_manager.get_sales_lines()</code>, pasando los filtros y los par√°metros de paginaci√≥n (<code>page</code>, <code>per_page</code>).</li>
                <li><strong>Manejo de Paginaci√≥n:</strong> Recibe una tupla <code>(datos, paginacion)</code> del manager. El objeto <code>pagination</code> contiene el total de registros, n√∫mero de p√°ginas, etc.</li>
                <li><strong>Renderizado:</strong> Pasa los datos de ventas filtrados y el objeto de paginaci√≥n a la plantilla <code>sales.html</code>.</li>
            </ol>

            <h3>3. Capa de Datos (<code>odoo_manager.py</code> - m√©todo <code>get_sales_lines</code>)</h3>
            <p>
                Este es el n√∫cleo de la extracci√≥n de datos. Se conecta a Odoo y construye una consulta compleja.
            </p>
            
            <h4>Modelo Principal de Odoo</h4>
            <p>La consulta se realiza sobre el modelo <code>account.move.line</code> (l√≠neas de asiento contable).</p>

            <h4>Construcci√≥n del Dominio (Filtros)</h4>
            <p>El dominio de la consulta se construye combinando filtros est√°ticos y din√°micos:</p>
            <ul>
                <li><strong>Filtros Est√°ticos (Hardcoded):</strong>
                    <ul>
                        <li><code>('move_id.journal_id.name', '=', 'F150 (Venta exterior)')</code>: Asegura que solo se obtengan facturas del diario de ventas internacionales.</li>
                        <li><code>('move_id.state', '=', 'posted')</code>: Solo facturas confirmadas.</li>
                        <li><code>('account_id.code', '=like', '70%')</code>: Solo l√≠neas que afectan a cuentas de ingresos (que empiezan con 70).</li>
                        <li><code>('tax_ids.name', 'ilike', 'EXE_IGV_EXP')</code>: Filtra por el impuesto espec√≠fico de exportaci√≥n.</li>
                        <li><code>('product_id', '!=', False)</code>: Excluye l√≠neas que no est√°n asociadas a un producto.</li>
                    </ul>
                </li>
                <li><strong>Filtros Din√°micos (del usuario):</strong>
                    <ul>
                        <li><strong>Fechas:</strong> Se a√±aden condiciones <code>('move_id.invoice_date', '>=', date_from)</code> y <code>('move_id.invoice_date', '<=', date_to)</code>.</li>
                        <li><strong>Cliente:</strong> Se a√±ade <code>('move_id.partner_id', '=', partner_id)</code>.</li>
                        <li><strong>B√∫squeda:</strong> Se construye una condici√≥n <code>OR</code> compleja para buscar el t√©rmino <code>search</code> en el nombre de la factura, origen, nombre/c√≥digo del producto y nombre del cliente.</li>
                    </ul>
                </li>
            </ul>

            <h4>Campos Obtenidos de Odoo</h4>
            <p>La consulta principal a <code>account.move.line</code> solicita campos clave como:</p>
            <pre><code>'move_id', 'partner_id', 'product_id', 'balance', 'move_name', 'quantity', 'price_unit', 'amount_currency', 'display_name'</code></pre>
            <div class="note">
                <strong><i class="bi bi-translate"></i>Idioma:</strong> Todas las consultas que extraen nombres de campos (como productos o clientes) incluyen <code>'context': {'lang': 'es_PE'}</code> para obtener las traducciones en espa√±ol directamente desde Odoo.
            </div>

            <h4>Obtenci√≥n de Datos Relacionados</h4>
            <p>
                Despu√©s de obtener las l√≠neas base, se realizan consultas adicionales para enriquecer los datos, usando los IDs recolectados:
            </p>
            <div class="note">
                <strong><i class="bi bi-search"></i>B√∫squeda Inversa de Pedidos:</strong> Para obtener el n√∫mero de pedido de venta de forma fiable, el sistema realiza una "b√∫squeda hacia atr√°s". Busca en `sale.order.line` las l√≠neas que generaron las `account.move.line` obtenidas. Esto es m√°s robusto que depender del campo de texto `invoice_origin`.
            </div>
            <ol>
                <li><strong>Facturas (<code>account.move</code>):</strong> Se obtienen detalles de las facturas (fecha, origen, vendedor, etc.).</li>
                <li><strong>Productos (<code>product.product</code>):</strong> Se obtienen todos los detalles del producto, incluyendo <code>display_name</code>, l√≠nea comercial, clasificaci√≥n farmacol√≥gica, etc.</li>
                <li><strong>Clientes (<code>res.partner</code>):</strong> Se obtienen el nombre y pa√≠s del cliente.</li>
                <li><strong>Pedidos (<code>sale.order</code>):</strong> Si la factura tiene un pedido de origen, se obtienen sus detalles.</li>
            </ol>

            <h4>Estructura Final</h4>
            <p>Finalmente, se ensambla una lista de diccionarios, donde cada diccionario representa una l√≠nea de venta con todos los datos combinados, lista para ser mostrada en la tabla.</p>
        </section>

        <section id="flujo-pending">
            <h2><i class="bi bi-clock-history"></i>Flujo de Datos: Pendientes (/pending)</h2>
            <p>
                Esta secci√≥n es muy similar a <code>/sales</code>, pero se enfoca en mostrar las l√≠neas de pedidos de venta que a√∫n no han sido completamente facturadas.
            </p>

            <h3>1. Interfaz y Backend (<code>templates/pending.html</code> y <code>app.py</code>)</h3>
            <p>
                El flujo es pr√°cticamente id√©ntico al de la vista de ventas: el formulario env√≠a los filtros, la ruta <code>pending()</code> en <code>app.py</code> los recibe y llama a <code>data_manager.get_pending_orders()</code>, pasando el resultado a la plantilla.
            </p>

            <h3>2. Capa de Datos (<code>odoo_manager.py</code> - m√©todo <code>get_pending_orders</code>)</h3>
            <p>
                La diferencia fundamental radica en el modelo y los filtros utilizados en Odoo.
            </p>

            <h4>Modelo Principal de Odoo</h4>
            <p>La consulta se realiza sobre el modelo <code>sale.order.line</code> (l√≠neas de pedido de venta).</p>

            <h4>Construcci√≥n del Dominio (Filtros)</h4>
            <ul>
                <li><strong>Filtros Est√°ticos (Hardcoded):</strong>
                    <ul>
                        <li><code>('order_id.team_id.name', 'ilike', 'INTERNACIONAL')</code>: Filtra por pedidos asignados al equipo de ventas internacional.</li>
                        <li><code>('order_id.state', 'in', ['credit', 'sale', 'done'])</code>: Solo pedidos en estados relevantes (aprobados para cr√©dito, confirmados o finalizados pero con saldo pendiente).</li>
                        <li><code>('product_id', '!=', False)</code>: Asegura que la l√≠nea tenga un producto asociado.</li>
                    </ul>
                </li>
                <li><strong>Filtros Din√°micos (del usuario):</strong>
                    <ul>
                        <li>Se aplican filtros de fecha, cliente y b√∫squeda de manera similar a <code>get_sales_lines</code>, pero sobre los campos del pedido (<code>order_id</code>).</li>
                    </ul>
                </li>
            </ul>

            <h4>L√≥gica de "Pendiente"</h4>
            <p>
                Una l√≠nea se considera "pendiente" si su campo <code>qty_to_invoice</code> es mayor que cero. Este campo es calculado por Odoo y representa la cantidad que a√∫n falta por facturar. Para pedidos en estado <code>credit</code>, este valor se calcula manualmente como <code>product_uom_qty - qty_invoiced</code>.
            </p>

            <h4>Campos y Datos Relacionados</h4>
            <p>
                El proceso es an√°logo al de ventas:
            </p>
            <ol>
                <li>Se obtienen las l√≠neas de pedido de venta (<code>sale.order.line</code>) que cumplen con el dominio.</li>
                <li>Se filtran aquellas con <code>qty_to_invoice > 0</code>.</li>
                <li>Se recolectan los IDs de los pedidos (<code>order_id</code>), productos (<code>product_id</code>) y clientes (<code>partner_id</code>).</li>
                <li>Se realizan consultas secundarias a los modelos <code>sale.order</code>, <code>product.product</code> y <code>res.partner</code> para obtener los detalles completos.</li>
                <li>Se ensambla la estructura de datos final, calculando el <code>total_pendiente</code> para cada l√≠nea.</li>
            </ol>

        </section>

        <section id="sistema-cache">
            <h2><i class="bi bi-lightning-charge-fill"></i> Sistema de Cach√©</h2>
            <p>
                Para mejorar el rendimiento y reducir la carga en el servidor de Odoo, la aplicaci√≥n implementa un sistema de cach√© en memoria, especialmente en la ruta m√°s consultada y costosa: el <strong>Dashboard Principal</strong> (<code>/dashboard</code>).
            </p>

            <h3>1. Prop√≥sito del Cach√©</h3>
            <p>
                La carga del dashboard principal implica m√∫ltiples y complejas consultas a Odoo para obtener ventas, pedidos pendientes y datos relacionados. Estas operaciones pueden ser lentas. El cach√© almacena el resultado de una petici√≥n ya procesada durante un tiempo determinado. Si otro usuario (o el mismo) realiza la misma petici√≥n dentro de ese tiempo, la aplicaci√≥n devuelve la respuesta guardada en lugar de volver a consultar y procesar todo desde cero.
            </p>
            <ul>
                <li><strong>Mejora la velocidad:</strong> Las cargas subsiguientes de la p√°gina son casi instant√°neas.</li>
                <li><strong>Reduce la carga de la API:</strong> Disminuye dr√°sticamente el n√∫mero de llamadas a Odoo.</li>
            </ul>

            <h3>2. Implementaci√≥n (<code>app.py</code>)</h3>
            <p>
                Se utiliza la librer√≠a <code>Flask-Caching</code>. La configuraci√≥n se define al inicio de <code>app.py</code>:
            </p>
            <pre><code># --- Configuraci√≥n de Cach√© ---
cache_config = {
    "CACHE_TYPE": "SimpleCache",  # Almacenamiento en memoria simple
    "CACHE_DEFAULT_TIMEOUT": 600  # 10 minutos de cach√© por defecto
}
cache = Cache(config=cache_config)
cache.init_app(app)</code></pre>
            <p>
                Luego, se aplica un decorador a la ruta del dashboard:
            </p>
            <pre><code>@app.route('/dashboard', methods=['GET', 'POST'])
@cache.cached(timeout=600, query_string=True)
def dashboard():
    # ... l√≥gica de la funci√≥n ...</code></pre>

            <h4>An√°lisis del Decorador <code>@cache.cached</code></h4>
            <ul>
                <li>
                    <code>timeout=600</code>: Especifica que el resultado de esta ruta se almacenar√° en cach√© durante <strong>600 segundos (10 minutos)</strong>. Despu√©s de este tiempo, la primera petici√≥n que llegue volver√° a ejecutar la funci√≥n y renovar√° el cach√©.
                </li>
                <li>
                    <code>query_string=True</code>: Este es un par√°metro crucial. Le indica al sistema de cach√© que cree una entrada de cach√© diferente para cada combinaci√≥n de par√°metros en la URL. Por ejemplo:
                    <ul>
                        <li><code>/dashboard</code> tendr√° su propio cach√©.</li>
                        <li><code>/dashboard?cliente_id=123</code> tendr√° un cach√© completamente separado.</li>
                        <li><code>/dashboard?cliente_id=456</code> tendr√° otro cach√© distinto.</li>
                    </ul>
                    Esto asegura que cuando un usuario filtra por un cliente espec√≠fico, vea los datos correctos para ese cliente y no los datos cacheados de "Todos los clientes".
                </li>
            </ul>
            <div class="note">
                <strong><i class="bi bi-exclamation-triangle-fill"></i>Importante:</strong> El cach√© se invalida autom√°ticamente despu√©s del `timeout`. Si se necesita forzar una actualizaci√≥n de datos antes de tiempo, ser√≠a necesario reiniciar la aplicaci√≥n Flask.
            </div>
        </section>

        <section id="seguridad-autenticacion">
            <h2><i class="bi bi-shield-lock-fill"></i> Seguridad y Autenticaci√≥n</h2>
            <p>
                La aplicaci√≥n implementa un sistema de autenticaci√≥n de dos capas para garantizar un acceso seguro.
            </p>

            <h3>1. Autenticaci√≥n en Odoo</h3>
            <p>
                El primer nivel de seguridad es la validaci√≥n de credenciales contra el servidor de Odoo. La ruta <code>/login</code> utiliza el m√©todo <code>data_manager.authenticate_user()</code> para verificar si el nombre de usuario y la contrase√±a son v√°lidos en Odoo.
            </p>

            <h3>2. Lista Blanca de Usuarios (Whitelist)</h3>
            <p>
                Incluso si un usuario tiene credenciales v√°lidas en Odoo, solo podr√° acceder a la aplicaci√≥n si su correo electr√≥nico est√° incluido en una lista blanca.
            </p>
            <ul>
                <li><strong>Archivo de Configuraci√≥n:</strong> La lista de usuarios autorizados se gestiona en el archivo <code>allowed_users.json</code>, ubicado en la ra√≠z del proyecto.</li>
                <li><strong>Formato del Archivo:</strong> El archivo contiene una clave <code>"allowed_emails"</code> con una lista de los correos electr√≥nicos permitidos.
                    <pre><code>{
    "allowed_emails": [
        "usuario1@empresa.com",
        "gerente.ventas@empresa.com"
    ]
}</code></pre>
                </li>
                <li><strong>Flujo de Validaci√≥n:</strong>
                    <ol>
                        <li>El usuario ingresa sus credenciales.</li>
                        <li><code>app.py</code> valida las credenciales contra Odoo.</li>
                        <li>Si son correctas, lee el archivo <code>allowed_users.json</code>.</li>
                        <li>Comprueba si el correo del usuario (<code>login</code>) est√° en la lista <code>allowed_emails</code>.</li>
                        <li>Si el usuario est√° en la lista, se le concede el acceso. Si no, se le muestra un mensaje de "Acceso no permitido" y se le deniega la entrada.</li>
                    </ol>
                </li>
            </ul>
        </section>

        <section id="integracion-google-sheets">
            <h2><i class="bi bi-file-earmark-spreadsheet-fill"></i> Integraci√≥n con Google Sheets</h2>
            <p>
                La aplicaci√≥n utiliza Google Sheets como una base de datos simple y accesible para gestionar toda la informaci√≥n relacionada con las <strong>metas de venta</strong> y la <strong>composici√≥n de los equipos comerciales</strong>. La clase <code>GoogleSheetsManager</code> en <code>google_sheets_manager.py</code> encapsula toda la l√≥gica de esta interacci√≥n.
            </p>

            <h3>1. Autenticaci√≥n y Configuraci√≥n</h3>
            <p>
                La conexi√≥n se establece utilizando una <strong>Cuenta de Servicio</strong> de Google Cloud.
            </p>
            <ul>
                <li><strong>Credenciales:</strong> Se requiere un archivo <code>credentials.json</code>, que contiene las claves de la cuenta de servicio. Este archivo debe estar en la ra√≠z del proyecto.</li>
                <li><strong>Permisos:</strong> La direcci√≥n de correo electr√≥nico de la cuenta de servicio (que se encuentra dentro de <code>credentials.json</code>) debe tener permisos de editor sobre el documento de Google Sheets que se va a utilizar.</li>
                <li><strong>Nombre de la Hoja:</strong> El nombre del documento de Google Sheets se especifica en la variable de entorno <code>GOOGLE_SHEET_NAME</code> en el archivo <code>.env</code>.</li>
            </ul>

            <h3>2. Estructura de Datos en Google Sheets</h3>
            <p>
                El sistema espera que el documento de Google Sheets contenga varias pesta√±as (hojas de c√°lculo) con una estructura espec√≠fica, donde los datos se almacenan en formato JSON en una √∫nica celda (generalmente <code>A1</code>) para simplificar la lectura y escritura.
            </p>
            <ul>
                <li>
                    <strong><code>metas_linea</code>:</strong> Almacena las metas mensuales por l√≠nea comercial. La estructura es un diccionario donde la clave es el mes (<code>YYYY-MM</code>) y el valor es otro diccionario con las metas.
                    <pre><code>{
    "2024-01": {
        "metas": {"petmedica": 10000, "agrovet": 15000},
        "metas_ipn": {"petmedica": 3000, "agrovet": 5000}
    }, ...
}</code></pre>
                </li>
                <li>
                    <strong><code>equipos</code>:</strong> Define qu√© vendedores pertenecen a cada equipo. La clave es el ID del equipo y el valor es una lista de IDs de vendedores.
                    <pre><code>{
    "petmedica": [10, 15, 22],
    "agrovet": [12, 18]
}</code></pre>
                </li>
                <li>
                    <strong><code>metas_vendedor</code>:</strong> Almacena las metas individuales de cada vendedor. Es una estructura anidada: <code>equipo -> vendedor_id -> mes -> {meta, meta_ipn}</code>.
                    <pre><code>{
    "petmedica": {
        "10": {
            "2024-01": {"meta": 5000, "meta_ipn": 1500},
            "2024-02": {"meta": 5500, "meta_ipn": 1600}
        }
    }, ...
}</code></pre>
                </li>
            </ul>

            <h3>3. Flujo de Lectura y Escritura</h3>
            <p>
                Las rutas de Flask como <code>/meta</code> y <code>/metas_vendedor</code> utilizan el <code>GoogleSheetsManager</code> para gestionar estos datos.
            </p>
            <ol>
                <li><strong>Lectura (GET):</strong> Cuando un usuario visita una p√°gina de metas, <code>app.py</code> llama a un m√©todo de lectura (ej. <code>gs_manager.read_metas()</code>). Este m√©todo lee el contenido JSON de la celda <code>A1</code> de la hoja correspondiente y lo deserializa en un diccionario de Python.</li>
                <li><strong>Procesamiento:</strong> La aplicaci√≥n utiliza este diccionario para rellenar los formularios y tablas que ve el usuario.</li>
                <li><strong>Escritura (POST):</strong> Cuando el usuario guarda los cambios, <code>app.py</code> recolecta los datos del formulario, reconstruye el diccionario de Python con la nueva informaci√≥n y llama a un m√©todo de escritura (ej. <code>gs_manager.write_metas()</code>). Este m√©todo serializa el diccionario a una cadena JSON y la escribe de nuevo en la celda <code>A1</code>, sobrescribiendo los datos anteriores.</li>
            </ol>
        </section>

        <section id="logica-dashboards">
            <h2><i class="bi bi-calculator-fill"></i> L√≥gica de los Dashboards</h2>
            <p>
                Esta secci√≥n detalla c√≥mo se procesan y calculan los datos para las vistas principales del dashboard, que son las m√°s complejas de la aplicaci√≥n.
            </p>

            <h3>1. Dashboard Internacional (<code>/dashboard</code>)</h3>
            <p>
                Esta vista consolida las ventas y pedidos pendientes del canal internacional para el a√±o en curso (o un rango de fechas espec√≠fico si se implementara).
            </p>
            <h4>Flujo de Datos</h4>
            <ol>
                <li><strong>Obtenci√≥n de Datos Crudos:</strong> La funci√≥n llama a <code>data_manager.get_sales_lines()</code> para obtener todas las l√≠neas de facturas del per√≠odo y a <code>data_manager.get_pending_orders()</code> para los pedidos pendientes. Ambas llamadas se pueden filtrar por un <code>partner_id</code> (cliente).</li>
                <li><strong>Obtenci√≥n de Metas:</strong> Llama a <code>gs_manager.read_metas_por_cliente()</code> para obtener las metas anuales de todos los clientes.</li>
                <li><strong>C√°lculo de KPIs Principales:</strong>
                    <ul>
                        <li><strong>Ventas Totales del A√±o:</strong> Se calcula sumando el campo <code>amount_currency</code> de todos los registros devueltos por <code>get_sales_lines</code>.</li>
                        <li><strong>Total Por Facturar:</strong> Se calcula sumando el campo <code>total_pendiente</code> de todos los registros de <code>get_pending_orders</code>.</li>
                        <li><strong>Meta y Brecha:</strong> La meta se calcula sumando las metas de los clientes (o del cliente seleccionado). La brecha es la diferencia entre la proyecci√≥n (Ventas + Por Facturar) y esta meta real.</li>
                    </ul>
                </li>
                <li><strong>Agregaci√≥n para Tabla Principal:</strong>
                    <ul>
                        <li>Se inicializa un diccionario <code>ventas_por_linea</code>. Se itera sobre los datos de ventas y se agrupan las sumas de <code>amount_currency</code> por el nombre de la l√≠nea comercial internacional (<code>commercial_line_international_id</code>).</li>
                        <li>De forma similar, se itera sobre los datos pendientes y se agrupan en <code>por_facturar_por_linea</code>.</li>
                        <li>Finalmente, se combinan ambos diccionarios para construir la tabla que el usuario ve en pantalla.</li>
                        <li>Para la columna "Meta" de la tabla, se suman las metas de los clientes correspondientes a cada l√≠nea comercial.</li>
                    </ul>
                </li>
                <li><strong>Preparaci√≥n de Datos para Gr√°ficos:</strong>
                    <ul>
                        <li><strong>Top Productos y Gr√°ficos de Pastel:</strong> Se agrupan las ventas por nombre de producto, clasificaci√≥n farmacol√≥gica, etc., para alimentar los gr√°ficos.</li>
                        <li><strong>An√°lisis Jer√°rquico (Drilldown):</strong> Se utiliza la librer√≠a <code>pandas</code> para convertir los datos de ventas en un DataFrame. Luego, se realizan agrupaciones sucesivas (<code>groupby</code>) para construir la estructura de datos jer√°rquica que espera el gr√°fico ECharts. La jerarqu√≠a actual es:
                            <ol>
                                <li><code>clasificacion_farma_nombre</code></li>
                                <li><code>forma_farma_nombre</code></li>
                                <li><code>via_admin_nombre</code></li>
                                <li><code>linea_prod_nombre</code></li>
                                <li><code>producto_nombre</code></li>
                            </ol>
                        </li>
                        <li><strong>Avance por Cliente (General):</strong> Se crean dos diccionarios, uno para agrupar las ventas facturadas por cliente y otro para los pendientes. Luego se unen para obtener el total de pedido (facturado + pendiente) y el avance para cada cliente. Este gr√°fico se oculta si se selecciona un cliente.</li>
                    </ul>
                </li>
                <li><strong>L√≥gica para Cliente Seleccionado:</strong>
                    <ul>
                        <li><strong>C√°lculos Din√°micos:</strong> Si se detecta un <code>partner_id</code> en los filtros, los c√°lculos de KPIs y de la tabla principal se rehacen usando solo los datos de ventas y metas de ese cliente espec√≠fico.</li>
                        <li><strong>Visualizaci√≥n de Gr√°ficos:</strong> En el frontend, el JavaScript detecta la presencia de <code>selectedClienteId</code> y alterna la visibilidad: oculta el gr√°fico general de clientes y muestra la tarjeta de avance y el gr√°fico de detalle de pedidos para el cliente seleccionado.</li>
                        <li><strong>Tabla de Productos del Cliente:</strong> Funcionalidad avanzada implementada en <code>dashboard_clean.html</code>:
                            <ul>
                                <li><strong>Activaci√≥n:</strong> Bot√≥n "üì¶ Productos" en el gr√°fico de Avance por Pedido que ejecuta <code>toggleProductosCliente()</code></li>
                                <li><strong>Procesamiento de datos:</strong> Funci√≥n <code>procesarProductosCliente()</code> que:
                                    <ul>
                                        <li>Itera <code>salesDataAll</code> y <code>pendingDataAll</code> (inyectados desde backend)</li>
                                        <li>Filtra por <code>partner_id === selectedClienteId</code></li>
                                        <li><strong>CR√çTICO:</strong> Usa <code>Map</code> con <code>productoKey = productoCodigo</code> (campo <code>default_code</code> o <code>codigo_odoo</code>) ‚Äî NUNCA nombre del producto</li>
                                        <li>Acumula cantidades y montos (facturado + pendiente) por c√≥digo √∫nico</li>
                                        <li>Pobla selector din√°mico de l√≠neas comerciales</li>
                                    </ul>
                                </li>
                                <li><strong>Filtrado:</strong> Funci√≥n <code>filtrarProductosCliente()</code> aplica filtros de estado y l√≠nea comercial, ordena por monto descendente</li>
                                <li><strong>Paginaci√≥n:</strong> Sistema completo con:
                                    <ul>
                                        <li>Constante <code>productosPorPagina = 15</code></li>
                                        <li>Variables globales: <code>productosFiltradosGlobal</code>, <code>paginaActualProductos</code></li>
                                        <li>Funci√≥n <code>cambiarPaginaProductos(direccion)</code> para navegaci√≥n</li>
                                        <li>Funci√≥n <code>renderizarTablaProductos()</code> usa <code>slice()</code> para mostrar solo p√°gina actual</li>
                                        <li>Reset autom√°tico a p√°gina 1 al cambiar filtros</li>
                                        <li>Info visual: "P√°gina X de Y (Z productos)"</li>
                                    </ul>
                                </li>
                                <li><strong>Datos de origen:</strong> Arrays globales inyectados con <code>{{ sales_data|tojson|safe }}</code> y <code>{{ pending_data|tojson|safe }}</code></li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ol>
        </section>

    </main>

    <script>
        // Script para resaltar la secci√≥n activa en la tabla de contenidos
        document.addEventListener('DOMContentLoaded', () => {
            const sections = document.querySelectorAll('section');
            const navLinks = document.querySelectorAll('#toc a');

            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        navLinks.forEach(link => {
                            link.classList.remove('active');
                            if (link.getAttribute('href').substring(1) === entry.target.id) {
                                link.classList.add('active');
                            }
                        });
                    }
                });
            }, { threshold: 0.3 });

            sections.forEach(section => {
                observer.observe(section);
            });
        });
    </script>

</body>
</html>